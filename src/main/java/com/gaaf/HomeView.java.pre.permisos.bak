package com.gaaf;





import java.util.ArrayList;
import java.util.List;
import javafx.scene.Parent;
import javafx.scene.control.Tooltip;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.control.Button;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.Priority;
import javafx.scene.layout.Region;
import javafx.scene.layout.VBox;

/**
 * Pantalla de inicio.
 * Botones centrados verticalmente a la izquierda.
 */
public class HomeView {
    private final BorderPane root;

    public HomeView(App app) {
        root = new BorderPane();
        root.setPadding(new Insets(10));

        // === BotÃ³n Cerrar SesiÃ³n ===
        Button btnCerrarSesion = new Button("Cerrar Sesion");
        btnCerrarSesion.setStyle(" -fx-background-color: linear-gradient(#A6D3EA, #7FB8D8); /* azul claro */-fx-text-fill: #1f2937;");


        btnCerrarSesion.setMaxWidth(Double.MAX_VALUE);
        btnCerrarSesion.setOnAction(e -> {
            Node n = (Node) e.getSource();
            javafx.stage.Stage stage = (javafx.stage.Stage) n.getScene().getWindow();
            stage.setTitle("LoginView");
            stage.getScene().setRoot(new LoginView(app).getRoot());
        });

        // === Otros botones ===
        Button btnInv = new Button("Ver inventario");
if (app.getUsuario().getRol() == Rol.OPERARIO) {
    btnInv.setDisable(false);
    btnInv.setVisible(true);
    btnInv.setManaged(true);
}
        btnInv.setOnAction(e -> app.mostrarInventario());

        Button btnPedidos = new Button("Ver pedidos");
        btnPedidos.setOnAction(e -> {
            Node n = (Node) e.getSource();
            javafx.stage.Stage st = (javafx.stage.Stage) n.getScene().getWindow();
            st.getScene().setRoot(new PedidosView(app).getRoot());
        });

        Button btnInsertarPedido = new Button("Insertar pedido");
if (app.getUsuario().getRol() == Rol.OPERARIO) {
    btnInsertarPedido.setVisible(false);
    btnInsertarPedido.setManaged(false);
} else if (!(app.tieneRol(Rol.ADMIN, Rol.COORDINADOR))) {
    btnInsertarPedido.setDisable(true);
    btnInsertarPedido.setOpacity(0.6);
    btnInsertarPedido.setTooltip(new Tooltip("No permitido para tu rol"));
}
if (!(app.tieneRol(Rol.ADMIN, Rol.COORDINADOR))) {
    btnInsertarPedido.setDisable(true);
    btnInsertarPedido.setOpacity(0.6);
    btnInsertarPedido.setTooltip(new Tooltip("No permitido para tu rol"));
}
        
    if (!app.tieneRol(Rol.ADMIN, Rol.COORDINADOR)) { new javafx.scene.control.Alert(javafx.scene.control.Alert.AlertType.WARNING, "No tienes permiso para usar esta función.").showAndWait(); return; }
            Node n = (Node) e.getSource();
            javafx.stage.Stage st = (javafx.stage.Stage) n.getScene().getWindow();
            st.getScene().setRoot(new PedidoInsertar(app));


// === Bloque de permisos por rol ===
Rol rolActual = app.getUsuario().getRol();
java.util.List<Button> botones = new java.util.ArrayList<>();
{
    java.util.Deque<Parent> stack = new java.util.ArrayDeque<>();
    if (this instanceof Parent) stack.push((Parent) this);
    while (!stack.isEmpty()) {
        Parent p = stack.pop();
        for (Node n : p.getChildrenUnmodifiable()) {
            if (n instanceof Button) botones.add((Button) n);
            if (n instanceof Parent) stack.push((Parent) n);
        }
    }
}
java.util.function.BiConsumer<Button, java.util.function.Supplier<Boolean>> proteger =
    (btn, permitido) -> {
        if (!permitido.get()) {
            btn.setDisable(true);
            btn.setOpacity(0.6);
            btn.setTooltip(new Tooltip("No permitido para tu rol"));
        }
        javafx.event.EventHandler<javafx.event.ActionEvent> original = btn.getOnAction();
        btn.setOnAction(e -> {
            if (!permitido.get()) {
                new javafx.scene.control.Alert(
                    javafx.scene.control.Alert.AlertType.WARNING,
                    "No tienes permiso para usar esta función."
                ).showAndWait();
                return;
            }
            if (original != null) original.handle(e);
        });
    };
for (Button b : botones) {
    String t = (b.getText() == null ? "" : b.getText()).trim().toLowerCase();
    boolean esInventario        = t.equals("ver inventario") || t.equals("inventario") || t.equals("bodega");
    boolean esInsertarPedido    = t.equals("insertar pedido");
    boolean esInsertarProveedor = t.equals("insertar proveedor") || t.equals("nuevo proveedor") || t.equals("agregar proveedor");
    boolean esEditarInventario  = t.equals("editar inventario") || t.equals("editar");
    switch (rolActual) {
        case OPERARIO:
            proteger.accept(b, () -> esInventario);
            break;
        case JEFE_BODEGA:
            proteger.accept(b, () -> esInventario || esEditarInventario);
            break;
        case COORDINADOR:
            proteger.accept(b, () -> esInventario || esInsertarPedido || esInsertarProveedor);
            break;
        case ADMIN:
            proteger.accept(b, () -> true);
            break;
    }
}
// === Fin bloque de permisos ===
});

        Button btnProv = new Button("Insertar proveedores");
        btnProv.setOnAction(e -> {
            Node n = (Node) e.getSource();
            javafx.stage.Stage st = (javafx.stage.Stage) n.getScene().getWindow();
            st.getScene().setRoot(new ProveedoresInsertar(app));
        });

        Button btnBod = new Button("Ver bodega");
        btnBod.setOnAction(e -> {
            Node n = (Node) e.getSource();
            javafx.stage.Stage st = (javafx.stage.Stage) n.getScene().getWindow();
            st.getScene().setRoot(new BodegaView(app).getRoot());
        });

        // === MenÃº de botones ===
        VBox menu = new VBox(10, btnInv, btnPedidos, btnInsertarPedido, btnProv, btnBod);
        menu.setPadding(new Insets(10));
        menu.setAlignment(Pos.CENTER_LEFT);
        menu.setFillWidth(true);

        // Todos los botones con mismo ancho
        btnInv.setMaxWidth(Double.MAX_VALUE);
        btnPedidos.setMaxWidth(Double.MAX_VALUE);
        btnInsertarPedido.setMaxWidth(Double.MAX_VALUE);
        btnProv.setMaxWidth(Double.MAX_VALUE);
        btnBod.setMaxWidth(Double.MAX_VALUE);

        // Espaciadores para centrar verticalmente
        Region top = new Region();
        Region bottom = new Region();
        VBox.setVgrow(top, Priority.ALWAYS);
        VBox.setVgrow(bottom, Priority.ALWAYS);

        // Columna izquierda con menÃº centrado y botÃ³n de cerrar sesiÃ³n abajo
        VBox left = new VBox(top, menu, bottom, btnCerrarSesion);
        left.setAlignment(Pos.CENTER_LEFT);
        left.setPadding(new Insets(10));
        left.setPrefWidth(200);

        // Centro: logo
        ImageView logo = new ImageView(new Image(getClass().getResource("/img/logo.png").toExternalForm()));
        logo.setFitWidth(360);
        logo.setPreserveRatio(true);
        VBox centro = new VBox(20, logo);
        centro.setAlignment(Pos.CENTER);

        // Aplicar al root
        root.setLeft(left);
        root.setCenter(centro);
        root.getStylesheets().add(getClass().getResource("/styles.css").toExternalForm());
    }

    public BorderPane getRoot() {
        return root;
    }
    // Recorre el árbol de nodos empezando desde 'root' y acumula todos los Button
    
}